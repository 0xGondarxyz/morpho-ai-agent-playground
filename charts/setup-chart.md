# Morpho Blue Setup Chart

## Production Deployment

```
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 1: Deploy Contracts                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌─────────────────────────────────────────────────────────────┐   │
│  │  Morpho                                                      │   │
│  │  new Morpho(ownerAddress)                                    │   │
│  │                                                              │   │
│  │  • Only production contract needed                           │   │
│  │  • Owner should be multisig for production                   │   │
│  └─────────────────────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│              STEP 2: Required Post-Deploy Configuration             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────┬────────────────────────────┐│
│  │             Call                  │         Purpose            ││
│  ├───────────────────────────────────┼────────────────────────────┤│
│  │ morpho.enableIrm(irmAddress)      │ Enable Interest Rate Model ││
│  ├───────────────────────────────────┼────────────────────────────┤│
│  │ morpho.enableLltv(0.9e18)         │ Enable LLTV (e.g., 90%)    ││
│  └───────────────────────────────────┴────────────────────────────┘│
│                                                                     │
│  ⚠️  Without these calls, no markets can be created!               │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│              STEP 3: Optional Post-Deploy Configuration             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────┬────────────────────────────┐│
│  │             Call                  │         Purpose            ││
│  ├───────────────────────────────────┼────────────────────────────┤│
│  │ morpho.setFeeRecipient(treasury)  │ Set where fees go          ││
│  ├───────────────────────────────────┼────────────────────────────┤│
│  │ morpho.setOwner(multisig)         │ Transfer to governance     ││
│  └───────────────────────────────────┴────────────────────────────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 4: Protocol Ready                           │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  Anyone can now:                                                    │
│  • Create markets with enabled IRMs and LLTVs                       │
│  • Supply, borrow, repay, liquidate, flash loan                     │
│                                                                     │
│  Owner can later:                                                   │
│  • Enable additional IRMs and LLTVs                                 │
│  • Set fees on markets (0-25%)                                      │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Test Environment Deployment

```
┌─────────────────────────────────────────────────────────────────────┐
│               STEP 1: Deploy Base Contracts (Parallel)              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────┬──────────────────────────────────────────────┐   │
│  │   Contract   │            Constructor Call                  │   │
│  ├──────────────┼──────────────────────────────────────────────┤   │
│  │ Morpho       │ new Morpho(deployer)                         │   │
│  ├──────────────┼──────────────────────────────────────────────┤   │
│  │ OracleMock   │ new OracleMock()                             │   │
│  ├──────────────┼──────────────────────────────────────────────┤   │
│  │ IrmMock      │ new IrmMock()                                │   │
│  ├──────────────┼──────────────────────────────────────────────┤   │
│  │ ERC20Mock    │ new ERC20Mock()  // loanToken                │   │
│  ├──────────────┼──────────────────────────────────────────────┤   │
│  │ ERC20Mock    │ new ERC20Mock()  // collateralToken          │   │
│  └──────────────┴──────────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│             STEP 2: Deploy Dependent Contracts                      │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌────────────────────┬────────────────────────────────────────┐   │
│  │     Contract       │          Constructor Call              │   │
│  ├────────────────────┼────────────────────────────────────────┤   │
│  │ FlashBorrowerMock  │ new FlashBorrowerMock(morpho)          │   │
│  └────────────────────┴────────────────────────────────────────┘   │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                STEP 3: Configure Contracts                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌───────────────────────────────────────┬────────────────────────┐│
│  │               Call                    │       Purpose          ││
│  ├───────────────────────────────────────┼────────────────────────┤│
│  │ morpho.enableIrm(irm)                 │ Enable IRM             ││
│  ├───────────────────────────────────────┼────────────────────────┤│
│  │ morpho.enableLltv(0.9e18)             │ Enable 90% LLTV        ││
│  ├───────────────────────────────────────┼────────────────────────┤│
│  │ oracle.setPrice(1e36)                 │ Set 1:1 price          ││
│  ├───────────────────────────────────────┼────────────────────────┤│
│  │ loanToken.setBalance(user, 1000e18)   │ Mint loan tokens       ││
│  ├───────────────────────────────────────┼────────────────────────┤│
│  │ collateral.setBalance(user, 1000e18)  │ Mint collateral        ││
│  └───────────────────────────────────────┴────────────────────────┘│
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 4: Create Test Market                         │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  morpho.createMarket({                                              │
│      loanToken: loanToken,                                          │
│      collateralToken: collateralToken,                              │
│      oracle: oracle,                                                │
│      irm: irm,                                                      │
│      lltv: 0.9e18                                                   │
│  });                                                                │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────────┐
│                  STEP 5: Ready for Testing                          │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  // User approves Morpho                                            │
│  loanToken.approve(morpho, type(uint256).max);                      │
│  collateralToken.approve(morpho, type(uint256).max);                │
│                                                                     │
│  // User can now interact                                           │
│  morpho.supply(marketParams, assets, 0, user, "");                  │
│  morpho.supplyCollateral(marketParams, assets, user, "");           │
│  morpho.borrow(marketParams, assets, 0, user, user);                │
│  // etc.                                                            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Dependency Graph (Visual)

```
                    ┌─────────────────┐
                    │     Owner       │
                    │   (address)     │
                    └────────┬────────┘
                             │
                             ▼
┌────────────────────────────────────────────────────────────────────┐
│                          LEVEL 1                                   │
│                    (No Dependencies)                               │
│                                                                    │
│   ┌─────────┐   ┌────────────┐   ┌─────────┐   ┌────────────┐    │
│   │ Morpho  │   │ OracleMock │   │ IrmMock │   │ ERC20Mock  │    │
│   │  (1)    │   │    (2)     │   │   (3)   │   │   (4,5)    │    │
│   └────┬────┘   └────────────┘   └─────────┘   └────────────┘    │
│        │                                                          │
└────────┼──────────────────────────────────────────────────────────┘
         │
         ▼
┌────────────────────────────────────────────────────────────────────┐
│                          LEVEL 2                                   │
│                   (Depends on Morpho)                              │
│                                                                    │
│                   ┌───────────────────┐                           │
│                   │ FlashBorrowerMock │                           │
│                   │       (6)         │                           │
│                   └───────────────────┘                           │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘
```

---

## Quick Reference

| Step | Contract | Command |
|------|----------|---------|
| 1 | Morpho | `new Morpho(owner)` |
| 2 | OracleMock | `new OracleMock()` |
| 3 | IrmMock | `new IrmMock()` |
| 4 | ERC20Mock (loan) | `new ERC20Mock()` |
| 5 | ERC20Mock (collateral) | `new ERC20Mock()` |
| 6 | FlashBorrowerMock | `new FlashBorrowerMock(morpho)` |
| - | Config | `morpho.enableIrm(irm)` |
| - | Config | `morpho.enableLltv(lltv)` |
| - | Config | `oracle.setPrice(price)` |
| - | Config | `token.setBalance(user, amount)` |
